service: mackerel-cloudwatch-logs-metric
# app and org for use with dashboard.serverless.com
#app: your-app-name
#org: your-org-name

frameworkVersion: ">=1.58.0"

provider:
  name: aws
  runtime: nodejs12.x
  environment:
    MACKEREL_APIKEY: ${ssm:MACKEREL_APIKEY~true}
    LOG_GROUP: /aws/lambda/mackerel-cloudwatch-logs-metric-dev-queue
# you can overwrite defaults here
#  stage: dev
#  region: us-east-1

  iamRoleStatements:
    - Effect: "Allow"
      Action:
        - "logs:StartQuery"
        # - "logs:ListTagsLogGroup"
        # - "logs:DescribeLogGroups"
        # - "logs:DescribeLogStreams"
        # - "logs:DescribeSubscriptionFilters"
        # - "logs:GetLogEvents"
        # - "logs:DescribeMetricFilters"
        # - "logs:FilterLogEvents"
        # - "logs:GetLogGroupFields"
      Resource: "arn:aws:logs:*:*:log-group:*"
    - Effect: "Allow"
      Action:
        - "logs:GetQueryResults"
        - "logs:StopQuery"
        - "logs:DescribeQueries"
        # - "logs:DescribeExportTasks"
        # - "logs:GetLogRecord"
        # - "logs:TestMetricFilter"
        # - "logs:DescribeResourcePolicies"
        # - "logs:GetLogDelivery"
        # - "logs:DescribeDestinations"
        # - "logs:ListLogDeliveries"
      Resource: "*"

package:
  include:
    - id
    - mkr

functions:
  queue:
    handler: handler.queue
    events:
     - schedule: rate(24 hours) # TODO: Fix rate
